const unsigned zebu_shifts[108][47] = {
	[1][2] = 51,
	[1][3] = 48,
	[1][4] = 56,
	[1][5] = 17,
	[1][6] = 12,
	[1][7] = 20,
	[1][8] = 2,
	[1][9] = 21,
	[1][10] = 24,
	[1][11] = 27,
	[1][16] = 109,
	[1][24] = 77,
	[1][26] = 93,
	[1][28] = 95,
	[1][34] = 105,
	[1][36] = 97,
	[1][38] = 107,
	[2][12] = 5,
	[2][13] = 3,
	[3][15] = 4,
	[5][12] = 6,
	[5][17] = 7,
	[5][19] = 11,
	[6][12] = 6,
	[6][17] = 7,
	[6][19] = 10,
	[7][18] = 8,
	[8][15] = 9,
	[12][12] = 13,
	[13][20] = 14,
	[14][21] = 15,
	[15][15] = 16,
	[17][12] = 18,
	[18][12] = 6,
	[18][17] = 7,
	[18][19] = 11,
	[18][20] = 14,
	[18][22] = 19,
	[19][18] = 8,
	[19][21] = 15,
	[20][12] = 5,
	[21][9] = 22,
	[21][10] = 24,
	[21][11] = 27,
	[21][26] = 42,
	[21][28] = 46,
	[22][23] = 23,
	[24][9] = 21,
	[24][10] = 25,
	[24][11] = 27,
	[24][24] = 36,
	[24][28] = 40,
	[25][25] = 26,
	[27][9] = 21,
	[27][10] = 24,
	[27][11] = 28,
	[27][24] = 30,
	[27][26] = 34,
	[28][27] = 29,
	[30][11] = 31,
	[30][29] = 33,
	[31][27] = 32,
	[34][11] = 31,
	[34][29] = 35,
	[36][10] = 37,
	[36][30] = 39,
	[37][25] = 38,
	[40][10] = 37,
	[40][30] = 41,
	[42][9] = 43,
	[42][31] = 45,
	[43][23] = 44,
	[46][9] = 43,
	[46][31] = 47,
	[48][2] = 51,
	[48][3] = 49,
	[48][4] = 56,
	[48][9] = 21,
	[48][10] = 25,
	[48][11] = 27,
	[48][24] = 36,
	[48][28] = 40,
	[48][36] = 65,
	[48][38] = 69,
	[49][25] = 26,
	[49][33] = 50,
	[51][2] = 52,
	[51][4] = 56,
	[51][32] = 54,
	[51][34] = 71,
	[51][38] = 75,
	[52][35] = 53,
	[54][2] = 51,
	[54][4] = 56,
	[54][32] = 55,
	[54][36] = 65,
	[54][38] = 69,
	[55][33] = 50,
	[56][2] = 51,
	[56][4] = 57,
	[56][32] = 54,
	[56][34] = 63,
	[56][36] = 59,
	[57][37] = 58,
	[59][4] = 60,
	[59][39] = 62,
	[60][37] = 61,
	[63][4] = 60,
	[63][39] = 64,
	[65][32] = 66,
	[65][40] = 68,
	[66][33] = 67,
	[69][32] = 66,
	[69][40] = 70,
	[71][2] = 72,
	[71][41] = 74,
	[72][35] = 73,
	[75][2] = 72,
	[75][41] = 76,
	[77][11] = 27,
	[77][28] = 79,
	[77][42] = 78,
	[79][9] = 21,
	[79][10] = 24,
	[79][11] = 27,
	[79][24] = 81,
	[79][26] = 83,
	[79][28] = 87,
	[79][43] = 80,
	[81][11] = 27,
	[81][28] = 79,
	[81][42] = 82,
	[83][9] = 21,
	[83][11] = 27,
	[83][24] = 85,
	[83][28] = 91,
	[83][44] = 84,
	[85][9] = 21,
	[85][10] = 24,
	[85][11] = 27,
	[85][24] = 81,
	[85][26] = 83,
	[85][28] = 87,
	[85][43] = 86,
	[87][9] = 21,
	[87][24] = 89,
	[87][45] = 88,
	[89][9] = 21,
	[89][10] = 24,
	[89][11] = 27,
	[89][24] = 81,
	[89][26] = 83,
	[89][28] = 87,
	[89][43] = 90,
	[91][9] = 21,
	[91][10] = 24,
	[91][11] = 27,
	[91][24] = 81,
	[91][26] = 83,
	[91][28] = 87,
	[91][43] = 92,
	[93][9] = 21,
	[93][11] = 27,
	[93][24] = 85,
	[93][28] = 91,
	[93][44] = 94,
	[95][9] = 21,
	[95][24] = 89,
	[95][45] = 96,
	[97][2] = 51,
	[97][4] = 56,
	[97][32] = 54,
	[97][34] = 101,
	[97][36] = 99,
	[97][38] = 103,
	[97][46] = 98,
	[99][2] = 51,
	[99][4] = 56,
	[99][32] = 54,
	[99][34] = 101,
	[99][36] = 99,
	[99][38] = 103,
	[99][46] = 100,
	[101][2] = 51,
	[101][4] = 56,
	[101][32] = 54,
	[101][34] = 101,
	[101][36] = 99,
	[101][38] = 103,
	[101][46] = 102,
	[103][2] = 51,
	[103][4] = 56,
	[103][32] = 54,
	[103][34] = 101,
	[103][36] = 99,
	[103][38] = 103,
	[103][46] = 104,
	[105][2] = 51,
	[105][4] = 56,
	[105][32] = 54,
	[105][34] = 101,
	[105][36] = 99,
	[105][38] = 103,
	[105][46] = 106,
	[107][2] = 51,
	[107][4] = 56,
	[107][32] = 54,
	[107][34] = 101,
	[107][36] = 99,
	[107][38] = 103,
	[107][46] = 108,
};
const unsigned zebu_reduces[110][33] = {
	[2][14] = 16,
	[3][14] = 15,
	[4][14] = 16,
	[8][14] = 15,
	[9][14] = 19,
	[10][14] = 19,
	[11][14] = 16,
	[15][14] = 15,
	[16][14] = 16,
	[22][9] = 23,
	[22][10] = 23,
	[22][11] = 23,
	[23][9] = 24,
	[23][10] = 24,
	[23][11] = 24,
	[25][9] = 25,
	[25][11] = 25,
	[26][9] = 26,
	[26][11] = 26,
	[28][9] = 27,
	[28][10] = 27,
	[28][11] = 27,
	[29][9] = 28,
	[29][10] = 28,
	[29][11] = 28,
	[31][9] = 27,
	[31][10] = 27,
	[31][11] = 27,
	[32][9] = 29,
	[32][10] = 29,
	[32][11] = 29,
	[33][9] = 28,
	[33][10] = 28,
	[33][11] = 28,
	[35][9] = 28,
	[35][10] = 28,
	[35][11] = 28,
	[37][9] = 25,
	[37][11] = 25,
	[38][9] = 30,
	[38][11] = 30,
	[39][9] = 26,
	[39][11] = 26,
	[41][9] = 26,
	[41][11] = 26,
	[43][9] = 23,
	[43][10] = 23,
	[43][11] = 23,
	[44][9] = 31,
	[44][10] = 31,
	[44][11] = 31,
	[45][9] = 24,
	[45][10] = 24,
	[45][11] = 24,
	[47][9] = 24,
	[47][10] = 24,
	[47][11] = 24,
	[49][2] = 33,
	[49][4] = 33,
	[49][9] = 25,
	[49][11] = 25,
	[49][32] = 33,
	[50][2] = 34,
	[50][4] = 34,
	[50][32] = 34,
	[52][2] = 35,
	[52][4] = 35,
	[52][32] = 35,
	[53][2] = 36,
	[53][4] = 36,
	[53][32] = 36,
	[55][2] = 33,
	[55][4] = 33,
	[55][32] = 33,
	[57][2] = 37,
	[57][4] = 37,
	[57][32] = 37,
	[58][2] = 38,
	[58][4] = 38,
	[58][32] = 38,
	[60][2] = 37,
	[60][4] = 37,
	[60][32] = 37,
	[61][2] = 39,
	[61][4] = 39,
	[61][32] = 39,
	[62][2] = 38,
	[62][4] = 38,
	[62][32] = 38,
	[64][2] = 38,
	[64][4] = 38,
	[64][32] = 38,
	[66][2] = 33,
	[66][4] = 33,
	[66][32] = 33,
	[67][2] = 40,
	[67][4] = 40,
	[67][32] = 40,
	[68][2] = 34,
	[68][4] = 34,
	[68][32] = 34,
	[70][2] = 34,
	[70][4] = 34,
	[70][32] = 34,
	[72][2] = 35,
	[72][4] = 35,
	[72][32] = 35,
	[73][2] = 41,
	[73][4] = 41,
	[73][32] = 41,
	[74][2] = 36,
	[74][4] = 36,
	[74][32] = 36,
	[76][2] = 36,
	[76][4] = 36,
	[76][32] = 36,
	[78][14] = 16,
	[79][14] = 43,
	[80][14] = 42,
	[82][14] = 43,
	[84][14] = 43,
	[85][14] = 43,
	[86][14] = 44,
	[88][14] = 43,
	[89][14] = 43,
	[90][14] = 45,
	[91][14] = 43,
	[92][14] = 44,
	[94][14] = 16,
	[96][14] = 16,
	[97][14] = 46,
	[98][14] = 16,
	[99][14] = 46,
	[100][14] = 46,
	[101][14] = 46,
	[102][14] = 46,
	[103][14] = 46,
	[104][14] = 46,
	[105][14] = 46,
	[106][14] = 16,
	[107][14] = 46,
	[108][14] = 16,
	[109][14] = 47,
};
const unsigned zebu_popcounts[110][33] = {
	[2][14] = 1,
	[3][14] = 0,
	[4][14] = 3,
	[8][14] = 0,
	[9][14] = 3,
	[10][14] = 2,
	[11][14] = 3,
	[15][14] = 0,
	[16][14] = 5,
	[22][9] = 0,
	[22][10] = 0,
	[22][11] = 0,
	[23][9] = 3,
	[23][10] = 3,
	[23][11] = 3,
	[25][9] = 0,
	[25][11] = 0,
	[26][9] = 3,
	[26][11] = 3,
	[28][9] = 0,
	[28][10] = 0,
	[28][11] = 0,
	[29][9] = 3,
	[29][10] = 3,
	[29][11] = 3,
	[31][9] = 0,
	[31][10] = 0,
	[31][11] = 0,
	[32][9] = 2,
	[32][10] = 2,
	[32][11] = 2,
	[33][9] = 3,
	[33][10] = 3,
	[33][11] = 3,
	[35][9] = 3,
	[35][10] = 3,
	[35][11] = 3,
	[37][9] = 0,
	[37][11] = 0,
	[38][9] = 2,
	[38][11] = 2,
	[39][9] = 3,
	[39][11] = 3,
	[41][9] = 3,
	[41][11] = 3,
	[43][9] = 0,
	[43][10] = 0,
	[43][11] = 0,
	[44][9] = 2,
	[44][10] = 2,
	[44][11] = 2,
	[45][9] = 3,
	[45][10] = 3,
	[45][11] = 3,
	[47][9] = 3,
	[47][10] = 3,
	[47][11] = 3,
	[49][2] = 0,
	[49][4] = 0,
	[49][9] = 0,
	[49][11] = 0,
	[49][32] = 0,
	[50][2] = 3,
	[50][4] = 3,
	[50][32] = 3,
	[52][2] = 0,
	[52][4] = 0,
	[52][32] = 0,
	[53][2] = 3,
	[53][4] = 3,
	[53][32] = 3,
	[55][2] = 0,
	[55][4] = 0,
	[55][32] = 0,
	[57][2] = 0,
	[57][4] = 0,
	[57][32] = 0,
	[58][2] = 3,
	[58][4] = 3,
	[58][32] = 3,
	[60][2] = 0,
	[60][4] = 0,
	[60][32] = 0,
	[61][2] = 2,
	[61][4] = 2,
	[61][32] = 2,
	[62][2] = 3,
	[62][4] = 3,
	[62][32] = 3,
	[64][2] = 3,
	[64][4] = 3,
	[64][32] = 3,
	[66][2] = 0,
	[66][4] = 0,
	[66][32] = 0,
	[67][2] = 2,
	[67][4] = 2,
	[67][32] = 2,
	[68][2] = 3,
	[68][4] = 3,
	[68][32] = 3,
	[70][2] = 3,
	[70][4] = 3,
	[70][32] = 3,
	[72][2] = 0,
	[72][4] = 0,
	[72][32] = 0,
	[73][2] = 2,
	[73][4] = 2,
	[73][32] = 2,
	[74][2] = 3,
	[74][4] = 3,
	[74][32] = 3,
	[76][2] = 3,
	[76][4] = 3,
	[76][32] = 3,
	[78][14] = 2,
	[79][14] = 0,
	[80][14] = 2,
	[82][14] = 2,
	[84][14] = 2,
	[85][14] = 0,
	[86][14] = 2,
	[88][14] = 2,
	[89][14] = 0,
	[90][14] = 2,
	[91][14] = 0,
	[92][14] = 2,
	[94][14] = 2,
	[96][14] = 2,
	[97][14] = 0,
	[98][14] = 2,
	[99][14] = 0,
	[100][14] = 2,
	[101][14] = 0,
	[102][14] = 2,
	[103][14] = 0,
	[104][14] = 2,
	[105][14] = 0,
	[106][14] = 2,
	[107][14] = 0,
	[108][14] = 2,
	[109][14] = 1,
};
const unsigned zebu_lexer[108][123] = {
	[1][32] = 1,
	[1][65] = 2,
	[1][66] = 3,
	[1][67] = 4,
	[1][97] = 5,
	[1][98] = 26,
	[1][99] = 27,
	[1][103] = 1,
	[5][97] = 6,
	[5][98] = 24,
	[6][97] = 7,
	[6][98] = 13,
	[7][97] = 8,
	[7][98] = 14,
	[8][97] = 9,
	[8][98] = 15,
	[9][97] = 10,
	[9][98] = 16,
	[10][97] = 11,
	[10][98] = 17,
	[11][97] = 6,
	[11][98] = 12,
	[12][98] = 13,
	[12][99] = 19,
	[13][98] = 14,
	[13][99] = 20,
	[14][98] = 15,
	[14][99] = 21,
	[15][98] = 16,
	[15][99] = 22,
	[16][98] = 17,
	[16][99] = 23,
	[17][98] = 12,
	[17][99] = 18,
	[18][99] = 19,
	[19][99] = 20,
	[20][99] = 21,
	[21][99] = 22,
	[22][99] = 23,
	[23][99] = 18,
	[24][98] = 13,
	[24][99] = 25,
	[25][99] = 20,
	[28][32] = 29,
	[28][58] = 30,
	[28][63] = 31,
	[28][103] = 29,
	[28][104] = 32,
	[29][32] = 29,
	[29][58] = 30,
	[29][63] = 31,
	[29][103] = 29,
	[32][104] = 32,
	[34][104] = 34,
	[36][32] = 36,
	[36][58] = 37,
	[36][103] = 36,
	[36][120] = 38,
	[36][121] = 38,
	[36][122] = 38,
	[39][32] = 39,
	[39][33] = 40,
	[39][103] = 39,
	[41][32] = 41,
	[41][58] = 42,
	[41][103] = 41,
	[43][32] = 44,
	[43][103] = 44,
	[43][119] = 44,
	[43][120] = 44,
	[43][121] = 44,
	[46][32] = 46,
	[46][46] = 47,
	[46][103] = 46,
	[48][32] = 49,
	[48][58] = 51,
	[48][103] = 49,
	[48][119] = 53,
	[48][120] = 54,
	[48][121] = 54,
	[48][122] = 52,
	[49][32] = 50,
	[49][58] = 51,
	[49][103] = 50,
	[49][120] = 52,
	[49][121] = 52,
	[49][122] = 52,
	[50][32] = 50,
	[50][58] = 51,
	[50][103] = 50,
	[50][120] = 52,
	[50][121] = 52,
	[50][122] = 52,
	[56][32] = 56,
	[56][33] = 57,
	[56][46] = 58,
	[56][103] = 56,
	[59][32] = 59,
	[59][66] = 60,
	[59][97] = 61,
	[59][98] = 60,
	[59][99] = 62,
	[59][103] = 59,
	[63][32] = 63,
	[63][97] = 64,
	[63][99] = 65,
	[63][103] = 63,
	[66][32] = 66,
	[66][99] = 67,
	[66][103] = 66,
	[68][32] = 68,
	[68][66] = 69,
	[68][98] = 69,
	[68][103] = 68,
	[70][32] = 70,
	[70][97] = 71,
	[70][103] = 70,
	[72][32] = 72,
	[72][65] = 73,
	[72][66] = 74,
	[72][67] = 75,
	[72][97] = 76,
	[72][98] = 77,
	[72][99] = 78,
	[72][103] = 72,
	[79][32] = 79,
	[79][65] = 80,
	[79][66] = 81,
	[79][67] = 82,
	[79][97] = 83,
	[79][99] = 84,
	[79][103] = 79,
	[85][32] = 85,
	[85][65] = 86,
	[85][66] = 87,
	[85][67] = 88,
	[85][103] = 85,
	[89][32] = 89,
	[89][67] = 90,
	[89][103] = 89,
	[91][32] = 91,
	[91][66] = 92,
	[91][103] = 91,
	[93][32] = 93,
	[93][65] = 94,
	[93][103] = 93,
	[95][32] = 96,
	[95][66] = 97,
	[95][97] = 98,
	[95][98] = 97,
	[95][99] = 99,
	[95][103] = 96,
	[95][104] = 100,
	[96][32] = 96,
	[96][66] = 97,
	[96][97] = 98,
	[96][98] = 97,
	[96][99] = 99,
	[96][103] = 96,
	[100][104] = 100,
	[102][32] = 103,
	[102][65] = 104,
	[102][66] = 105,
	[102][67] = 106,
	[102][103] = 103,
	[102][104] = 107,
	[103][32] = 103,
	[103][65] = 104,
	[103][66] = 105,
	[103][67] = 106,
	[103][103] = 103,
	[107][104] = 107,
};
const unsigned zebu_firsts[48][39] = {
	[16][2] = 1,
	[16][3] = 1,
	[16][4] = 1,
	[16][5] = 1,
	[16][6] = 1,
	[16][7] = 1,
	[16][8] = 1,
	[16][9] = 1,
	[16][10] = 1,
	[16][11] = 1,
	[16][24] = 1,
	[16][26] = 1,
	[16][28] = 1,
	[16][32] = 1,
	[16][34] = 1,
	[16][36] = 1,
	[16][38] = 1,
	[24][9] = 1,
	[26][3] = 1,
	[26][10] = 1,
	[28][11] = 1,
	[34][3] = 1,
	[34][32] = 1,
	[36][2] = 1,
	[38][4] = 1,
	[47][2] = 1,
	[47][3] = 1,
	[47][4] = 1,
	[47][5] = 1,
	[47][6] = 1,
	[47][7] = 1,
	[47][8] = 1,
	[47][9] = 1,
	[47][10] = 1,
	[47][11] = 1,
	[47][16] = 1,
	[47][32] = 1,
};
const unsigned zebu_starts[110] = {
	[1] = 1,
	[2] = 28,
	[3] = 34,
	[4] = 34,
	[5] = 36,
	[6] = 36,
	[7] = 39,
	[8] = 34,
	[9] = 34,
	[10] = 34,
	[11] = 34,
	[12] = 41,
	[13] = 43,
	[14] = 46,
	[15] = 34,
	[16] = 34,
	[17] = 41,
	[18] = 48,
	[19] = 56,
	[20] = 41,
	[21] = 59,
	[22] = 59,
	[23] = 59,
	[24] = 59,
	[25] = 63,
	[26] = 63,
	[27] = 59,
	[28] = 59,
	[29] = 59,
	[30] = 66,
	[31] = 59,
	[32] = 59,
	[33] = 59,
	[34] = 66,
	[35] = 59,
	[36] = 68,
	[37] = 63,
	[38] = 63,
	[39] = 63,
	[40] = 68,
	[41] = 63,
	[42] = 70,
	[43] = 59,
	[44] = 59,
	[45] = 59,
	[46] = 70,
	[47] = 59,
	[48] = 72,
	[49] = 79,
	[50] = 85,
	[51] = 85,
	[52] = 85,
	[53] = 85,
	[54] = 85,
	[55] = 85,
	[56] = 85,
	[57] = 85,
	[58] = 85,
	[59] = 89,
	[60] = 85,
	[61] = 85,
	[62] = 85,
	[63] = 89,
	[64] = 85,
	[65] = 91,
	[66] = 85,
	[67] = 85,
	[68] = 85,
	[69] = 91,
	[70] = 85,
	[71] = 93,
	[72] = 85,
	[73] = 85,
	[74] = 85,
	[75] = 93,
	[76] = 85,
	[77] = 66,
	[78] = 34,
	[79] = 95,
	[80] = 34,
	[81] = 66,
	[82] = 34,
	[83] = 63,
	[84] = 34,
	[85] = 95,
	[86] = 34,
	[87] = 70,
	[88] = 34,
	[89] = 95,
	[90] = 34,
	[91] = 95,
	[92] = 34,
	[93] = 63,
	[94] = 34,
	[95] = 70,
	[96] = 34,
	[97] = 102,
	[98] = 34,
	[99] = 102,
	[100] = 34,
	[101] = 102,
	[102] = 34,
	[103] = 102,
	[104] = 34,
	[105] = 102,
	[106] = 34,
	[107] = 102,
	[108] = 34,
	[109] = 34,
};
const unsigned zebu_defaults[56] = {
	[43] = 45,
	[44] = 44,
	[45] = 44,
	[48] = 55,
	[49] = 53,
	[53] = 53,
	[54] = 53,
	[55] = 53,
};
const unsigned zebu_EOFs[108] = {
	[28] = 33,
	[32] = 33,
	[34] = 35,
	[95] = 101,
	[100] = 101,
	[102] = 108,
	[107] = 108,
};
const unsigned zebu_accepts[109] = {
	[2] = 2,
	[3] = 3,
	[4] = 4,
	[5] = 9,
	[18] = 6,
	[19] = 7,
	[20] = 6,
	[22] = 5,
	[25] = 8,
	[26] = 10,
	[27] = 11,
	[30] = 12,
	[31] = 13,
	[33] = 14,
	[35] = 14,
	[37] = 12,
	[38] = 17,
	[40] = 18,
	[42] = 12,
	[43] = 20,
	[44] = 20,
	[47] = 21,
	[48] = 20,
	[49] = 20,
	[51] = 12,
	[52] = 17,
	[53] = 20,
	[54] = 22,
	[57] = 18,
	[58] = 21,
	[60] = 10,
	[61] = 9,
	[62] = 11,
	[64] = 9,
	[65] = 11,
	[67] = 11,
	[69] = 10,
	[71] = 9,
	[73] = 2,
	[74] = 3,
	[75] = 4,
	[76] = 9,
	[77] = 10,
	[78] = 11,
	[80] = 2,
	[81] = 32,
	[82] = 4,
	[83] = 9,
	[84] = 11,
	[86] = 2,
	[87] = 32,
	[88] = 4,
	[90] = 4,
	[92] = 32,
	[94] = 2,
	[97] = 10,
	[98] = 9,
	[99] = 11,
	[101] = 14,
	[104] = 2,
	[105] = 32,
	[106] = 4,
	[108] = 14,
};
const char* zebu_grammar_names[49] = {
	[47] = "(start)",
	[23] = "(trie #0)",
	[31] = "(trie #1)",
	[37] = "(trie #10)",
	[39] = "(trie #11)",
	[15] = "(trie #12)",
	[19] = "(trie #13)",
	[42] = "(trie #14)",
	[43] = "(trie #15)",
	[44] = "(trie #16)",
	[45] = "(trie #17)",
	[46] = "(trie #18)",
	[25] = "(trie #2)",
	[30] = "(trie #3)",
	[27] = "(trie #4)",
	[29] = "(trie #5)",
	[35] = "(trie #6)",
	[41] = "(trie #7)",
	[33] = "(trie #8)",
	[40] = "(trie #9)",
	[24] = "0.a",
	[26] = "0.b",
	[28] = "0.c",
	[36] = "1.a",
	[34] = "1.b",
	[38] = "1.c",
	[16] = "start",
};
#include <stdlib.h>
#include <stddef.h>
#include <assert.h>
#include <stdio.h>
#include <string.h>
#include <stdarg.h>

struct zebu_state
{
	struct { unsigned* data, n, cap; } y;
	struct { unsigned char* data, n, cap; } l;
	unsigned lstate, t;
};

static void push(struct zebu_state* this, unsigned ystate)
{
	if (this->y.n + 1 >= this->y.cap)
	{
		this->y.cap = this->y.cap << 1 ?: 1;
		this->y.data = realloc(this->y.data, sizeof(*this->y.data) * this->y.cap);
	}
	
	this->y.data[this->y.n++] = ystate;
}

static void append(struct zebu_state* this, const unsigned char* text, size_t length)
{
	while (this->l.n + length >= this->l.cap)
	{
		this->l.cap = this->l.cap << 1 ?: 1;
		this->l.data = realloc(this->l.data, this->l.cap);
	}
	memcpy(this->l.data + this->l.n, text, length);
	this->l.n += length;
}

static void ddprintf(struct zebu_state* this, const char* fmt, ...)
{
	for (unsigned i = 0, n = this->y.n; i < n; i++)
	{
		printf("%u ", this->y.data[i]);
	}
	
	printf("| ");
	
	va_list va;
	va_start(va, fmt);
	vprintf(fmt, va);
	va_end(va);
}

struct zebu_state* new_zebu_state() {
	struct zebu_state* this = malloc(sizeof(*this));
	assert(this);
	this->y.data = NULL, this->y.n = 0, this->y.cap = 0;
	this->l.data = NULL, this->l.n = 0, this->l.cap = 0;
	this->lstate = 1, this->t = 0;
	push(this, 1);
	return this;
}

void zebu_reset(struct zebu_state* this) {
	this->y.n = 0;
	this->l.n = 0;
	this->lstate = 1;
	push(this, 1);
}

#define N(array) (sizeof(array) / sizeof(*array))

static void process_token(struct zebu_state* this, unsigned t) {
	ddprintf(this, "t == %u\n", t);
	
	unsigned b, d, p, y = this->y.data[this->y.n - 1];
	
	while (!(y < N(zebu_shifts) && t < N(*zebu_shifts) && (b = zebu_shifts[y][t])))
	{
		if (y < N(zebu_reduces) && t < N(*zebu_reduces) && (b = zebu_reduces[y][t]))
		{
			ddprintf(this, "b == %u\n", b);
			ddprintf(this, "g == \"%s\"\n", zebu_grammar_names[b]);
			ddprintf(this, "p == %u\n", p = zebu_popcounts[y][t]);
			
			this->y.n -= p;
			
			if (!this->y.n) return;
			
			y = this->y.data[this->y.n - 1];
			
			ddprintf(this, "y == %u\n", y);
			
			assert(y < N(zebu_shifts) && b < N(*zebu_shifts));
			
			d = zebu_shifts[y][b];
			
			push(this, d), y = d;
			
			ddprintf(this, "y == %u\n", y);
		}
		else
		{
			assert(!"TODO");
			exit(1);
		}
	}
	
	push(this, b), y = b;
}

void zebu_parse(struct zebu_state* this, const unsigned char* text, size_t length) {
	unsigned c, l = this->lstate;
	unsigned a, b, i, n, f, t = this->t;
	
	i = this->l.n;
	
	append(this, text, length);
	
	for (n = this->l.n, f = 0; i < n;)
	{
		c = this->l.data[i];
		
		{
			unsigned j, s;
			unsigned char escaped[(n - i) * 4 + 1], *e = escaped;
			for (j = i; j < n; j++)
				switch (s = this->l.data[j]) {
					case 'a' ... 'z':
					case 'A' ... 'Z':
					case '0' ... '9':
					case '!':
					case ':':
					case '.':
					case '+':
					case '%':
					case '[':
					case '{':
					case '-':
					case '}':
					case '*':
					case '|':
					case ',':
					case '@':
					case '<':
					case '>':
					case '&':
					case '~':
					case '^':
					case '/':
					case '?':
					case ' ':
					case ']':
					case '(': case ')':
					*e++ = s;
					break;
					case '\n':
						*e++ = '\\';
						*e++ = 'n';
					case '\\':
						*e++ = '\\';
						*e++ = '\\';
						break;
					case '\"':
						*e++ = '\\';
						*e++ = '"';
					break;
					default:
						printf("s = %c\n", s);
						assert(!"TODO");
						break;
				}
			*e = 0;
			ddprintf(this, "c == %u \"%s\"\n", c, escaped);
		}
		
		a = (c < N(*zebu_lexer) ? zebu_lexer[l][c] : 0) ?: (l < N( zebu_defaults) ? zebu_defaults[l] : 0);
		b = (l < N(zebu_accepts) ? zebu_accepts[l] : 0);
		
		if (a)
		{
			if (b)
			{
				l = a, t = b, f = i++;
				ddprintf(this, "l = %u, t == %u, f = %u (saved)\n", l, t, f);
			}
			else
			{
				l = a, i++;
				ddprintf(this, "l == %u\n", l);
			}
		}
		else if (b)
		{
			process_token(this, b);
			l = zebu_starts[this->y.data[this->y.n - 1]], f = i, t = 0;
			ddprintf(this, "l == %u, f = %u, t = %u\n", l, f, t);
		}
		else if (t)
		{
			process_token(this, t);
			l = zebu_starts[this->y.data[this->y.n - 1]], i = f, t = 0;
			ddprintf(this, "l == %u, i = %u, t = %u\n", l, i, t);
		}
		else
		{
			assert(!"TODO");
		}
	}
	
	memcpy(this->l.data, this->l.data + f, this->l.n = n - f);
	
	this->t = t;
	
	this->lstate = l;
}

void zebu_parse_EOF(struct zebu_state* this) {
	unsigned i = this->l.n, n = i, l = this->lstate;
	unsigned a, b, c, f = 0, t = this->t;
	
	while (1)
	{
		assert(i <= n + 1);
		
		if (i < n)
		{
			c = this->l.data[i];
			
			{
				unsigned j, s;
				unsigned char escaped[(n - i) * 4 + 1], *e = escaped;
				for (j = i; j < n; j++)
					switch (s = this->l.data[j]) {
						case 'a' ... 'z':
						case 'A' ... 'Z':
						case '0' ... '9':
						case '+':
						case ':':
						case '.':
						case '{':
						case '}':
						case '%':
						case '!':
						case '~':
						case '[':
						case '*':
						case '>':
						case '^':
						case '?':
						case '/':
						case '|':
						case '<':
						case '@':
						case '-':
						case '&':
						case ']':
						case ',':
						case ' ':
							*e++ = s;
							break;
						case '\n':
							*e++ = '\\';
							*e++ = 'n';
						case '\"':
							*e++ = '\\';
							*e++ = '"';
						break;
					case '\\':
						*e++ = '\\';
						*e++ = '\\';
						break;
						default:
							printf("s = %c\n", s);
							assert(!"TODO");
							break;
					}
				*e = 0;
				ddprintf(this, "c == %u (%s)\n", c, escaped);
			}
			
			a = (c < N(*zebu_lexer) ? zebu_lexer[l][c] : 0) ?: (l < N( zebu_defaults) ? zebu_defaults[l] : 0);
		}
		else
		{
			ddprintf(this, "c == <EOF>\n");
			a = l < N(zebu_EOFs) ? zebu_EOFs[l] : 0;
		}
		
		b = (l < N(zebu_accepts) ? zebu_accepts[l] : 0);
		
		if (a)
		{
			if (b)
			{
				l = a, t = b, f = i++;
				ddprintf(this, "l = %u, t == %u, f = %u (saved)\n", l, t, f);
			}
			else
			{
				l = a, i++;
				ddprintf(this, "l == %u\n", l);
			}
		}
		else if (b)
		{
			process_token(this, b);
			l = zebu_starts[this->y.data[this->y.n - 1]], f = i, t = 0;
			ddprintf(this, "l == %u, f = %u, t = %u\n", l, f, t);
			if (f > n) break;
		}
		else if (t)
		{
			process_token(this, t);
			l = zebu_starts[this->y.data[this->y.n - 1]], i = f, t = 0;
			ddprintf(this, "l == %u, i = %u, t = %u\n", l, i, t);
		}
		else
		{
			assert(!"TODO");
		}
	}
}

void free_zebu_state(struct zebu_state* this) {
	free(this->y.data);
	free(this->l.data);
	free(this);
}
